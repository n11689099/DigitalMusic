# Digital Music Analysis

## Overview
Digital Music Analysis is a WPF application that visualises the contents of a WAV file against the expected notation stored in a MusicXML score. When the program starts it prompts the user to choose matching audio and score files, then performs spectral analysis, onset detection, histogram rendering, and staff alignment so you can inspect tuning accuracy and timing visually.

## Project structure
```
DigitalMusicAnalysis.sln        – Visual Studio solution file
DigitalMusicAnalysis/            – Main WPF project
├── App.xaml(.cs)               – Application bootstrap
├── DigitalMusicAnalysis.csproj – Project metadata and package references
├── MainWindow.xaml             – Window layout (tabs for frequency, histogram, and staff views)
├── MainWindow.xaml.cs          – Interaction logic, analysis pipeline, UI event handlers
├── musicNote.cs                – Representation of detected or scored musical notes
├── noteGraph.cs                – Utility for constructing per-octave histogram bars
├── timefreq.cs                 – Short-time Fourier transform (STFT) implementation
└── wavefile.cs                 – Lightweight WAV reader used for analysis
```

The `obj/` directory is generated by the build and can be ignored.

## Key components
### User interface (XAML)
`MainWindow.xaml` defines three primary tabs:
* **Frequency** – Displays a time–frequency spectrogram that you can zoom horizontally.
* **Octaves** – Shows per-octave histograms for five pitch ranges with labels for note names.
* **Staff** – Renders the aligned score and detected notes on a staff along with pitch statistics.

### Analysis pipeline (`MainWindow.xaml.cs`)
The window constructor orchestrates the workflow:
1. Prompt for the WAV recording and the companion MusicXML score.
2. Load raw audio samples with `wavefile` and NAudio's `WaveFileReader` for playback.
3. Compute a short-time Fourier transform via `timefreq` to populate the spectrogram bitmap.
4. Build histogram views (`noteGraph`) for the current time slice selected by the slider.
5. Parse the score XML into `musicNote` objects and detect note onsets from the spectrogram energy.
6. Estimate per-note pitch using a custom FFT and align detected notes with the score through a dynamic-programming string matcher.
7. Populate the staff canvas with coloured note heads, stems, and tooltips showing frequency error.
8. Start audio playback with `WaveOut` while a background thread keeps the slider in sync.

### Domain model helpers
* `wavefile` manually parses the WAV header and normalises 8-bit sample data to floats for analysis.
* `timefreq` implements an STFT using a recursive FFT and precomputed twiddle factors; the result feeds the spectrogram and histograms.
* `musicNote` converts a frequency to pitch-class information, staff positioning, accidental flags, and error metrics relative to equal temperament.
* `noteGraph` slices FFT magnitudes into octave-specific bins and exposes them as rectangle heights for the histogram canvases.

## Dependencies
The project targets .NET Core 3.1 with WPF enabled and pulls in the [NAudio](https://github.com/naudio/NAudio) package for WAV playback (`WaveFileReader`, `WaveOut`). Windows is required to build and run WPF applications.

## Building and running
1. Open the solution (`DigitalMusicAnalysis.sln`) in Visual Studio 2019 or later on Windows.
2. Restore NuGet packages (NAudio) if prompted.
3. Build and run the `DigitalMusicAnalysis` project.
4. When prompted, choose the audio (WAV) file and matching MusicXML score.

As the audio plays you can switch between tabs to inspect the spectrogram, frequency histograms, and staff alignment. Use the slider or arrow buttons to scrub through time, and hover over a note head in the staff view to see expected pitch, measured frequency, and percentage error.

## Extending the codebase
* Adjust analysis resolution by changing the STFT window length passed to `timefreq` in `MainWindow.xaml.cs`.
* Enhance onset detection by tweaking the high-frequency content threshold or replacing it with another detection method.
* Support additional score formats by extending `readXML` or creating new parsers that populate `musicNote` instances.
* Improve rendering by replacing manual canvas drawing with higher-level controls or adding legends and tooltips to the histogram view.

## Repository notes
`REBASE_RESOLVE.md` documents the current rebase state if a merge conflict occurs; it is not used by the application itself.
